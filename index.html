<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Alankar Maker üé∂</title>

    <!-- Firebase SDK -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getFirestore, collection, addDoc, getDocs, updateDoc, doc,
        increment, onSnapshot, query, orderBy
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      // üî• Your Firebase config
      const firebaseConfig = {
        apiKey: "YOUR_KEY_HERE",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      window.db = db;
    </script>

    <!-- SoundFont Player -->
    <script src="https://unpkg.com/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>

    <style>
      body {
        font-family: "Inter", sans-serif;
        background: url("https://images.pexels.com/photos/7135058/pexels-photo-7135058.jpeg?auto=compress&cs=tinysrgb&w=1600") no-repeat center center fixed;
        background-size: cover;
        color: #333;
        margin: 0;
      }
      .container {
        max-width: 800px; margin: 60px auto;
        background: rgba(255, 253, 249, 0.9);
        border-radius: 18px;
        box-shadow: 0 8px 22px rgba(0,0,0,.05);
        padding: 40px 50px;
      }
      h2 { text-align:center; margin-bottom:25px; color:#3d3b33; }
      .tabs { display:flex; justify-content:center; margin-bottom:25px; }
      .tab { flex:1; text-align:center; padding:12px; cursor:pointer;
             border-bottom:3px solid transparent; font-weight:600; color:#666; transition:.2s; }
      .tab.active { border-color:#c58c85; color:#3d3b33; background:#fdf6f3; }
      .tab:hover { background:#f8f3f0; }
      .tab-content { display:none; }
      .tab-content.active { display:block; }
      .centered { text-align:center; }
      .note-buttons input { margin:6px; padding:12px 20px; font-size:16px; border-radius:8px;
                            border:none; background:#e9f5ec; color:#3d3b33; transition:.2s; cursor:pointer; }
      .note-buttons input:hover { background:#d9f0e0; }
      select, input[type="text"], button, input[type="range"] {
        padding:10px 14px; border-radius:8px; border:1px solid #d9c9b3;
        font-size:15px; margin:5px; background:#fdfcf8; color:#3d3b33;
      }
      button { background:#c8a99e; color:#fff; border:none; cursor:pointer; transition:.3s; }
      button:hover { background:#b89286; }
      #seq { width:60%; }
      #library div { border:1px solid #e8e1d9; background:#fefcf8;
                     padding:12px; margin:8px auto; border-radius:10px; }
      #library button { background:#c58c85; font-size:14px; margin:4px; padding:6px 10px; }
      #library button:hover { background:#b97a74; }
      footer { text-align:center; color:#7a756d; font-size:14px; margin-top:30px; }
      .lib-card.playing {
        border-color:#a6d8a8; background:#e8f9e9;
        box-shadow:0 0 8px rgba(100,180,120,0.4);
        transition:all 0.3s ease;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>üé∂ Alankar Maker (Shared Library)</h2>
      <div class="tabs">
        <div class="tab active" onclick="openTab('create')">Create / Play</div>
        <div class="tab" onclick="openTab('library')">Library</div>
      </div>

      <!-- Create Tab -->
      <div id="create" class="tab-content active centered">
        <div class="note-buttons">
          <input type="button" value="1" onclick="append_note(this.value)">
          <input type="button" value="2" onclick="append_note(this.value)">
          <input type="button" value="3" onclick="append_note(this.value)">
          <input type="button" value="4" onclick="append_note(this.value)">
          <input type="button" value="5" onclick="append_note(this.value)">
          <input type="button" value="6" onclick="append_note(this.value)">
          <input type="button" value="7" onclick="append_note(this.value)">
        </div>

        <br>
        <label><b>Instrument:</b></label>
        <select id="instrument" onchange="loadInstrument()">
          <option value="acoustic_grand_piano">Piano</option>
          <option value="sitar">Sitar</option>
          <option value="drawbar_organ">Harmonium</option>
          <option value="acoustic_guitar_nylon">Guitar</option>
          <option value="flute">Flute</option>
          <option value="violin">Violin</option>
        </select>

        <br><br>
        <label><b>Tempo (Speed):</b></label>
        <input type="range" id="tempo" min="1" max="5" value="1" step="1"
               oninput="tempoDisplay.innerText=this.value">
        <span id="tempoDisplay">1</span>

        <br><br>
        <input type="text" id="seq" placeholder='Use _ for pause, " for sustain'>
        <button onclick="clear_sequence()">Clear</button>
        <button onclick="play_sequence()">Play</button>

        <br><br>
        <button onclick="saveAlankar()">üíæ Save to Shared Library</button>
      </div>

      <!-- Library Tab -->
      <div id="library" class="tab-content">
        <h3>üéµ Shared Alankar Library</h3>
        <div id="library-list"></div>
      </div>
    </div>
    <footer>¬© 2025 Alankar Maker</footer>

    <script type="module">
        // ---------------- Firebase Imports ----------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import {
          getFirestore, collection, addDoc, getDocs, updateDoc, doc,
          increment, onSnapshot, query, orderBy
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
      
        // ---------------- Firebase Config ----------------
        const firebaseConfig = {
          apiKey: "AIzaSyDoCtGjssZ41qMthQrihOPD_wYJrdVXfr0",
          authDomain: "alankar-maker.firebaseapp.com",
          projectId: "alankar-maker",
          storageBucket: "alankar-maker.firebasestorage.app",
          messagingSenderId: "565148625631",
          appId: "1:565148625631:web:4d819f8190f9d5fb49d76a",
          measurementId: "G-P3GTJ27L88"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
      
        // ---------------- SoundFont Setup ----------------
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const ac = new AudioContext();
        let currentInstrumentPlayer = null;
        let currentPlaybackAbort = null;
        let warmedUp = false;
      
        const NOTE_MAP = {
          '1': 'C4', '2': 'D4', '3': 'E4', '4': 'F4', '5': 'G4', '6': 'A4', '7': 'B4',
          '8': 'C5', '9': 'D5', '10': 'E5', '11': 'F5', '12': 'G5', '13': 'A5', '14': 'B5'
        };
      
        // ---------------- Functions ----------------
        async function loadInstrument() {
          let instName = document.getElementById('instrument').value;
          if (instName === "piano") instName = "acoustic_grand_piano";
          else if (instName === "organ") instName = "drawbar_organ";
          else if (instName === "guitar") instName = "acoustic_guitar_nylon";
          currentInstrumentPlayer = await Soundfont.instrument(ac, instName);
        }
      
        function append_note(v) {
          document.getElementById('seq').value += v.trim();
        }
      
        function clear_sequence() {
          if (currentPlaybackAbort) currentPlaybackAbort.abort();
          document.getElementById('seq').value = "";
        }
      
        document.getElementById('seq').addEventListener('input', e => {
          e.target.value = e.target.value.replace(/ /g, '_');
        });
      
        function parseSequence(raw) {
          const chars = raw.split('');
          const parsed = [];
          for (let i = 0; i < chars.length; i++) {
            const ch = chars[i];
            if (ch === '"') {
              if (parsed.length > 0) parsed[parsed.length - 1].mult += 1;
            } else {
              parsed.push({ note: ch, mult: 1 });
            }
          }
          return parsed;
        }
      
        function computeStepMs() {
          const t = parseInt(document.getElementById('tempo').value, 10);
          const mapped = t + 4;
          return Math.max(80, 560 - (mapped * 48));
        }
      
        async function play_sequence() {
          if (!currentInstrumentPlayer) await loadInstrument();
          if (currentPlaybackAbort) currentPlaybackAbort.abort();
          const controller = new AbortController();
          currentPlaybackAbort = controller;
          await ac.resume();
      
          let raw = document.getElementById('seq').value.trim();
          raw = raw.replace(/[^1-7_""]/g, '');
          document.getElementById('seq').value = raw;
          if (!raw) return alert("Enter a valid sequence with 1‚Äì7, _ or \"");
      
          const base = parseSequence(raw);
          const expanded = [];
          for (let i = 0; i < 5; i++) {
            base.forEach(p => expanded.push({
              note: (p.note === '_' ? '_' : String(Number(p.note) + i)),
              mult: p.mult
            }));
          }
      
          const sleep = ms => new Promise(r => {
            const id = setTimeout(r, ms);
            controller.signal.addEventListener('abort', () => clearTimeout(id), { once: true });
          });
      
          for (let i = 0; i < expanded.length; i++) {
            if (controller.signal.aborted) return;
      
            const stepMs = computeStepMs();
            const { note, mult } = expanded[i];
      
            if (note === '_') {
              await sleep(stepMs * mult);
              continue;
            }
      
            const midi = NOTE_MAP[note];
            if (!midi) { await sleep(stepMs * mult); continue; }
      
            const durSec = (stepMs * mult) / 1000 * 0.9;
            currentInstrumentPlayer.play(midi, ac.currentTime, { duration: durSec });
            await sleep(stepMs * mult);
          }
      
          currentPlaybackAbort = null;
        }
      
        async function saveAlankar() {
          const seq = document.getElementById('seq').value.trim();
          if (!seq) return alert("Enter a sequence first!");
          const instrument = document.getElementById('instrument').value;
          const tempo = parseInt(document.getElementById('tempo').value, 10);
          const timestamp = Date.now();
      
          const snapshot = await getDocs(collection(db, "alankars"));
          const exists = snapshot.docs.some(d => d.data().sequence === seq);
          if (exists) return alert("Already in library!");
      
          await addDoc(collection(db, "alankars"), { name: seq, sequence: seq, instrument, tempo, votes: 0, time: timestamp });
          alert("Saved to Shared Library!");
        }
      
        function renderLibrary() {
          const div = document.getElementById('library-list');
          div.innerHTML = "<p>Loading...</p>";
      
          const q = query(collection(db, "alankars"), orderBy("votes", "desc"), orderBy("time", "desc"));
          onSnapshot(q, snapshot => {
            if (snapshot.empty) {
              div.innerHTML = "<p>No Alankars yet. Be the first to add one!</p>";
              return;
            }
      
            div.innerHTML = snapshot.docs.map((docSnap) => {
              const a = docSnap.data();
              return `
                <div id="lib-item-${docSnap.id}" class="lib-card">
                  <b>${a.name}</b> (${a.instrument}, tempo ${a.tempo}) ‚Äî ‚ù§Ô∏è ${a.votes}<br>
                  <button onclick="playFromFirestore('${docSnap.id}')">‚ñ∂ Play</button>
                  <button onclick="voteFirestore('${docSnap.id}')">üëç Vote</button>
                </div>
              `;
            }).join("");
          });
        }
      
        async function playFromFirestore(id) {
          const snapshot = await getDocs(collection(db, "alankars"));
          const item = snapshot.docs.find(d => d.id === id)?.data();
          if (!item) return;
      
          document.getElementById('instrument').value = item.instrument;
          document.getElementById('tempo').value = item.tempo;
          document.getElementById('tempoDisplay').innerText = item.tempo;
          document.getElementById('seq').value = item.sequence;
      
          await loadInstrument();
          await play_sequence();
        }
      
        async function voteFirestore(id) {
          const docRef = doc(db, "alankars", id);
          await updateDoc(docRef, { votes: increment(1) });
        }
      
        function openTab(tabName) {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          document.querySelector(`[onclick="openTab('${tabName}')"]`).classList.add('active');
          document.getElementById(tabName).classList.add('active');
          if (tabName === 'library') renderLibrary();
        }
      
        // ---------------- Warmup ----------------
        let warmedUp = false;
        function warmUpAudio() {
            if (warmedUp) return;
            warmedUp = true;
            ac.resume().then(async () => {
            // load default instrument if not yet loaded
            if (!currentInstrumentPlayer) await loadInstrument();

            // play a silent note to force-load buffers
            try {
                currentInstrumentPlayer.play("C4", ac.currentTime, { gain: 0.0001, duration: 0.05 });
            } catch (e) {
                console.warn("Audio warm-up skipped:", e);
            }
            });
        }
        // attach listener once
        window.addEventListener("click", warmUpAudio, { once: true });
        window.addEventListener("touchstart", warmUpAudio, { once: true });
        
        window.onload = () => {
          loadInstrument();
          renderLibrary();
        };
    
        window.append_note = append_note;
        window.clear_sequence = clear_sequence;
        window.play_sequence = play_sequence;
        window.saveAlankar = saveAlankar;
        window.openTab = openTab;
        window.voteFirestore = voteFirestore;
        window.playFromFirestore = playFromFirestore;
    </script>
      
  </body>
</html>
